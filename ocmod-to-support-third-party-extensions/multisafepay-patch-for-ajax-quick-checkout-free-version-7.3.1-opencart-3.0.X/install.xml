<?xml version="1.0" encoding="utf-8"?>
<modification>
	<name>MultiSafepay: Patch for AJAX Quick Checkout 7.3.1 for OC version 3.0.X</name>
    <version>1.0</version>
    <code>MSP-AJAX-QUICK-CHECKOUT-PATCH</code>
    <author>MultiSafepay</author>
    <link>https://www.multisafepay.com</link>
    <file path="catalog/view/theme/default/template/extension/payment/multisafepay.twig">
    	<operation info="Set validations in view file">
            <search><![CDATA[{% if test_mode %}]]></search>
            <add position="replace" offset="161"><![CDATA[

<style>.show-always {display: inline-block !important;}</style>
<div class="ve-card">
    <div class="ve-card__header">
        <h4 class="ve-h4">{{ text_legend }}</h4>
    </div>
    <div class="ve-card__section">
        {% if test_mode %}
            <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ text_testmode }}</div>
        {% endif %}
        <form action="{{ action }}" method="post" class="form-horizontal" id="multisafepay-form">
            <input type="hidden" name="order_id" value="{{ order_id }}" />
            <input type="hidden" name="type" value="{{ type }}" />
            {% if gateway %}
                <input type="hidden" name="gateway" value="{{ gateway }}" />
            {% endif %}
            {% if gateway_info %}
                <input type="hidden" name="gateway_info" value="{{ gateway_info }}" />
            {% endif %}
            {% if issuers %}
                <fieldset>
                    <div class="form-group form-group-issuer-id">
                        <label class="col-sm-2 control-label" for="input-issuer-id">{{ entry_issuer }} </label>
                        <div class="col-sm-10">
                            <select name="issuer_id" id="input-issuer-id" class="form-control">
                                <option value="">{{ text_select }}</option>
                                {% for issuer in issuers %}
                                    <option value="{{ issuer.code }}">{{ issuer.description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </fieldset>
            {% endif %}
            {% if fields %}
                <fieldset>
                    {% if fields.gender %}
                        <div class="form-group required form-group-gender">
                            <label class="col-sm-2 control-label" for="input-gender">{{ entry_gender }} </label>
                            <div class="col-sm-10">
                                <select name="gender" id="input-gender" class="form-control">
                                    <option value="">{{ text_select }}</option>
                                    <option value="mr">{{ text_mr }}</option>
                                    <option value="mrs">{{ text_mrs }}</option>
                                    <option value="miss">{{ text_miss }}</option>
                                </select>
                            </div>
                        </div>
                    {% endif %}
                    {% if fields.sex %}
                        <div class="form-group required form-group-gender">
                            <label class="col-sm-2 control-label" for="input-gender">{{ entry_gender }} </label>
                            <div class="col-sm-10">
                                <select name="gender" id="input-gender" class="form-control">
                                    <option value="">{{ text_select }}</option>
                                    <option value="male">{{ text_mr }}</option>
                                    <option value="female">{{ text_mrs }}</option>
                                </select>
                            </div>
                        </div>
                    {% endif %}
                    {% if fields.birthday %}
                        <div class="form-group required form-group-birthday">
                            <label class="col-sm-2 control-label" for="input-birthday">{{ entry_date_of_birth }} </label>
                            <div class="col-sm-10">
                                <div class="input-group date">
                                    <input type="text" name="birthday" value="" placeholder="{{ placeholder_date_of_birth }}" id="input-birthday" data-date-format="YYYY-MM-DD" class="form-control" />
                                    <span class="input-group-btn">
                            <button type="button" class="btn btn-default show-always"><i class="fa fa-calendar"></i></button>
                        </span>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    {% if fields.bankaccount %}
                        <div class="form-group required form-group-bankaccount">
                            <label class="col-sm-2 control-label" for="input-bankaccount">{{ entry_bank_account }} </label>
                            <div class="col-sm-10">
                                <input type="text" name="bankaccount" value="" placeholder="{{ placeholder_bank_account }}" id="input-bankaccount" class="form-control" />
                            </div>
                        </div>
                    {% endif %}
                    {% if fields.account_holder_name %}
                        <div class="form-group required form-group-account-holder-name">
                            <label class="col-sm-2 control-label" for="input-account-holder-name">{{ entry_account_holder_name }} </label>
                            <div class="col-sm-10">
                                <input type="text" name="account_holder_name" value="" placeholder="{{ entry_account_holder_name }}" id="input-account-holder-name" class="form-control" />
                            </div>
                        </div>
                    {% endif %}
                    {% if fields.account_holder_iban %}
                        <div class="form-group required form-group-account-holder-iban">
                            <label class="col-sm-2 control-label" for="input-account-holder-iban">{{ entry_account_holder_iban }} </label>
                            <div class="col-sm-10">
                                <input type="text" name="account_holder_iban" value="" placeholder="{{ placeholder_account_holder_iban }}" id="input-account-holder-iban" class="form-control" />
                            </div>
                        </div>
                    {% endif %}
                    {% if fields.emandate %}
                        <input type="hidden" name="emandate" value="{{ order_id }}" />
                    {% endif %}
                </fieldset>
            {% endif %}
            <div class="buttons">
                <div class="pull-right">
                    <input id="button-confirm" type="submit" value="{{ button_confirm }}" class="btn btn-primary" />
                </div>
            </div>
        </form>
    </div>
    {% if gateway == 'APPLEPAY' %}
        <script type="text/javascript"><!--
            $( document ).ready(function() {
                if (window.ApplePaySession && ApplePaySession.canMakePayments()) {
                    $('.qc-confirm button').prop('disabled', false);
                } else {
                    $('#multisafepay-form').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ text_error_apple_pay }}</div>');
                    $('.qc-confirm button').prop('disabled', true);
                }
            });
            //--></script>
    {% endif %}
    {% if fields.birthday %}
        <script type="text/javascript"><!--
            $('.date').datetimepicker({
                language: '{{ datepicker }}',
                pickTime: false
            });
            //--></script>
    {% endif %}
    {% if fields %}
        <script type="text/javascript"><!--
            $( document ).ready(function() {
                $('#multisafepay-form').on('click', '#button-confirm', function(e) {
                    e.preventDefault();
                    $.ajax({
                        url: 'index.php?route=extension/payment/multisafepay/validateForm',
                        type: 'post',
                        data: $('#multisafepay-form :input, #multisafepay-form select'),
                        dataType: 'json',
                        cache: false,
                        beforeSend: function() {
                            $('#multisafepay-form').unbind();
                            $('#multisafepay-form .alert-danger').remove();
                            $('#multisafepay-form .text-danger').remove();
                            $('#multisafepay-form .form-group').removeClass('has-error');
                            $('.qc-confirm button').button('loading');
                        },
                        complete: function() {
                            $('.qc-confirm button').button('reset');
                            $(".show-always").blur();
                        },
                        success: function(json) {
                            if(!json['error']) {
                                $("#multisafepay-form").submit();
                            }
                            if(json['error']) {
                                $('#multisafepay-form').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ text_error_on_submit }}</div>');
                                $.each( json['error'], function( index, value ){
                                    $('.form-group-'+ index + ' .col-sm-10').append('<div class="text-danger">' + value + '</div>');
                                    $('.form-group-'+ index).addClass('has-error');
                                });
                                return;
                            }
                        }
                    });
                });
            });
            //--></script>
    {% else %}
    <script type="text/javascript"><!--
            $( document ).ready(function() {
            	$('#multisafepay-form').unbind(); 
            });
            //--></script>
    {% endif %}
</div>
            ]]>
            </add>
        </operation>    	
    </file>
    <file path="catalog/model/extension/d_quickcheckout/method.php">
    	<operation info="Set all payment methods at front">
            <search><![CDATA[public function getPaymentMethods($payment_address, $total){]]></search>
            <add position="before"><![CDATA[
	private function sortMethods($method_data) {
		$sort_order = array();
		foreach($method_data as $key => $value) {
			if(strpos($key, 'multisafepay') !== false && $value['sort_order']) {
				$sort_order[$key] = $this->config->get('payment_multisafepay_sort_order') . '.' . $value['sort_order'];
			}
			if(strpos($key, 'multisafepay') !== false && !$value['sort_order']) {
				$sort_order[$key] = $this->config->get('payment_multisafepay_sort_order');
			}
			if(strpos($key, 'multisafepay') === false) {
				$sort_order[$key] = $value['sort_order'];
			}
		}
		array_multisort($sort_order, SORT_ASC, SORT_NATURAL, $method_data);
		return $method_data;
	}

	private function extractPaymentMethodsArray($method, $extension, $total, $recurring = false, $method_data = array()) {
		if ($method && $extension['code'] === 'multisafepay') {
			$methods = $this->{'model_extension_payment_'.$extension['code']}->getMethods($this->session->data['payment_address'],
				$total);
			foreach ($methods as $msp_method) {
				$method_data[$msp_method['code']] = $msp_method;
			}
			return $method_data;
		}
		if ($method && $extension['code'] !== 'multisafepay' && $recurring) {
			if (property_exists($this->{'model_extension_payment_'.$extension['code']},
					'recurringPayments') && $this->{'model_extension_payment_'.$extension['code']}->recurringPayments()) {
				$method_data[$method['code']] = $method;
				return $method_data;
			}
		}
		if ($method && $extension['code'] !== 'multisafepay' && !$recurring) {
			$method_data[$method['code']] = $method;
			return $method_data;
		}
	}

	private function getMultiSafepayImageByGatewayRoute($route) {
		$gateways = $this->multisafepay->getGateways();
		$gateway_key = array_search($route, array_column($gateways, 'route'));
		if(isset($gateways[$gateway_key]['image'])) {
			return $gateways[$gateway_key]['image'];
		}
		return false;
	}

	public function __construct($registry) {
		parent::__construct($registry);
		$this->registry->set('multisafepay', new Multisafepay($registry));
		$this->registry->set('multisafepay_version_control', new Multisafepayversioncontrol($registry));
		$this->key_prefix = $this->multisafepay_version_control->getKeyPrefix();
	}
            ]]>
            </add>
        </operation>
    	<operation info="Set all payment methods at front">
            <search><![CDATA[$method_data[$result['code']] = $method;]]></search>
            <add position="replace"><![CDATA[
								$method_data = $this->extractPaymentMethodsArray($method, $result, $total, $recurring, $method_data);
            ]]>
            </add>
        </operation>
        <operation info="Set payment methods icons at front">
            <search><![CDATA[if(file_exists(DIR_IMAGE.'catalog/d_quickcheckout/payment/'.$result['code'].'.png')){]]></search>
            <add position="before"><![CDATA[
                    foreach ($method_data as $method_key => $multisafepay_method) {
						$method_data[$method_key]['image'] = '';
					}
					if ($this->config->get($this->key_prefix . 'multisafepay_use_payment_logo')) {
						$this->load->model('tool/image');
						foreach ($method_data as $multisafepay_method_key => $multisafepay_method) {
							$image = $this->getMultiSafepayImageByGatewayRoute($multisafepay_method['code']);
							if($image && file_exists(DIR_IMAGE.'catalog/multisafepay/' . $image . '.png')) {
								$method_data[$multisafepay_method_key]['image'] = $this->model_tool_image->resize( 'catalog/multisafepay/' . $image . '.png', 32, 32);
							}
						}
					}
            ]]>
            </add>
        </operation>
	</file>
    <file path="catalog/model/extension/payment/multisafepay.php">
        <operation info="Remove icons on title string">
            <search><![CDATA[$title = $this->getTitle($gateway['description'], $gateway['image']);]]></search>
            <add position="replace"><![CDATA[
					$title = $gateway['description'];
            ]]>
            </add>
        </operation>
    </file>
</modification>